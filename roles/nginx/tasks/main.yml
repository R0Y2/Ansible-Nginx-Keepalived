---
# Configure nginx
- name: Check if the nginx default site conf exists
  stat:
    path: /etc/nginx/sites-enabled/default
  register: cfg_ngx_default

- name: Move sites-enabled/default to sites-disabled
  shell: |
    mkdir -p /etc/nginx/sites-disabled/default
    mv /etc/nginx/sites-enabled/default /etc/nginx/sites-disabled/default
  when: cfg_ngx_default.stat.exists
  register: sh_res
  changed_when: sh_res.rc == 0

- name: Generate nginx configuration file
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    mode: '0644'
    validate: nginx -t -c %s
  register: ngx_cfg_rendered

- name: Notify nginx restart handler
  command: echo "Restart nginx if config changed"
  notify: "restart nginx"
  changed_when: ngx_cfg_rendered.changed
